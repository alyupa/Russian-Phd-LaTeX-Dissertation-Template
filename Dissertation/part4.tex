\chapter{Использование высокопроизводительных вычислительных систем} \label{ch:ch4}

В данной работе рассматривается применение технологии программно-аппаратной архитектуры параллельных вычислений CUDA, позволяющей производить вычисления на графических процессорах (GPU), к задачам трехфазной фильтрации.
Портирование кода происходило на базе примеров из ~\cite{Sanders-CUDA}.
Также реализована возможность многопроцессорных вычислений с использованием
интерфейса передачи сообщений MPI.

\section{Практические аспекты программной реализации} \label{ch:ch4/sect1}

В работе представлен гибкий и хорошо масштабируемый механизм разделения
расчетной сетки на локальные подсетки. Благодаря такому механизму
нет необходимости хранить расчетную сетку целиком на каком-либо из
процессоров, а преобразование локальных координат в глобальные
позволяет воссоздать общую картину полученных в результате расчетов
данных. Для однородности способа обращения к данным независимо
от размерности задачи используется одномерная индексация массивов.

Параллельная реализация основана на принципе геометрического параллелизма.
Возможно деление области на подобласти как в~одном, так и двух или трех направлениях.
Примеры разбиения области изображены на ~\ref{pic_div}.
Перед непосредственным стартом вычислений оцениваем с помощью разработанного алгоритма расчетное время в зависимости от разбиения
области, выясняем, какой способ деления области предпочтительнее и эффективнее в точки зрения распределения нагрузки между вычислительными узлами.

\begin{figure}[!h]\center
\includegraphics[width=1\textwidth]{div.png} 
\caption{Деление расчетной области на подобласти в одном, двух или трех направлениях}
\label{pic_div}
\end{figure}

Можно сказать, что процесоры образуют сетку, в~которой местоположение каждого процессора может быть задано с~помощью декартовых координат.

Для лучшей масштабируемости системы, удобства визуализации и обращения
к данным ведется запись результатов расчетов всеми процессорами в один большой файл -- каждый процессор
пишет свой фрагмент этого файла. Реализован механизм синхронизации доступа к файлу.

\section{Результаты расчетов на суперкомпьютере} \label{ch:ch4/sect2}

Большая часть расчетов проводилась на гибридном вычислительном кластере К-100~\ref{pic_k100}, расположенном в ИПМ им. М.В.Келдыша РАН.
Ускорения и эффективность вычислений были проанализированы на примере трехмерной тестовой задачи~\ref{ch:ch3/sect3}.
Время расчета измерялось с помощью счетчика, встроенного в программный код.

\begin{figure}[!h]\center
\includegraphics[width=0.8\textwidth]{k100.pdf} 
\caption{Структура гибридного кластера К100}
\label{pic_k100}
\end{figure}

Исследуем ускорения и эффективности вычислений в зависимости от числа
используемых для расчета процессоров. Результаты измерений приведены
на графиках (Рис.~\ref{mpi_speedup}, Рис.~\ref{mpi_eff}).
Измерялось время расчета 50 шагов по времени на сетке размером 4 миллиона узлов.
Ступенчатая структура ускорений и, следовательно, скачки эффективности наблюдаются
в связи с неодинаковым способом распределения нагрузки между процессорами
в зависимости от их числа, а также погрешностью вычислений. Сохранение высокой
эффективности вычислений (84-95\%) обусловлено значительным превосходством времени, требуемого
непосредственно для расчета, по~сравнению с временем, необходимым для обмена данными
между процессорами.

\begin{figure}[!h]
\begin{center}
\begin{tikzpicture}
  \begin{axis}[axis lines=left, enlargelimits=true, grid=major, width=0.7\textwidth, xlabel={\textit{число процессоров}}, ylabel={\textit{ускорение}}]
    \pgfplotstableread{data/mpi_times.txt}{\mytable}
    \pgfplotstablegetelem{0}{Y}\of{\mytable}
    \pgfmathsetmacro{\ay}{\pgfplotsretval}
    \addplot [blue, mark=*] table [x=X, y expr=\ay/\thisrow{Y}] {\mytable};
  \end{axis}
\end{tikzpicture}
\caption{Зависимость ускорения расчета тестовой задачи от числа процессоров}
\label{mpi_speedup}
\end{center}
\end{figure}

\begin{figure}[!h]
\begin{center}
\begin{tikzpicture}
  \begin{axis}[axis lines=left, enlargelimits=true, grid=major, width=0.7\textwidth, xlabel={\textit{число процессоров}}, ylabel={\textit{эффективность}}]
    \pgfplotstableread{data/mpi_times.txt}{\mytable}
    \pgfplotstablegetelem{0}{Y}\of{\mytable}
    \pgfmathsetmacro{\ay}{\pgfplotsretval}
    \addplot [blue,mark=*] table [x=X, y expr=\ay/\thisrow{Y}/\thisrow{X}] {\mytable};
  \end{axis}
\end{tikzpicture}
\caption{Зависимость эффективности расчета тестовой задачи от числа процессоров}
\label{mpi_eff}
\end{center}
\end{figure}

Рассмотрим, как меняется время решения поставленной задачи при~проведении расчетов на~GPU
с~помощью CUDA. На~Рис.~\ref{cuda_speedup} изображена зависимость укорения тестового расчета на~одном GPU
по~сравнению с~одним CPU. Измерения проводились для~различного числа
узлов расчетной сетки. Как видно из~приведенного на~Рис.~\ref{cuda_speedup}
графика, для~сеток малого размера (8000 узлов) возможно замедление расчетов, но~при~увеличении
размера сетки наблюдается все большее ускорение расчета. При~этом для~большей из~
рассмотренных сеток (2.2 миллиона узлов) полученное ускорение составило 3.5 раза.

\begin{figure}[!h]
\begin{center}
\begin{tikzpicture}
  \begin{axis}[axis lines=left, enlargelimits=true, grid=major, width=0.7\textwidth, xlabel={\textit{число узлов сетки}}, ylabel={\textit{ускорение}}]
    \pgfplotstableread[skip first n=1]{data/cpu_vs_gpu.txt}{\mytable}
    \addplot [blue, mark=*] table [x=0, y expr=\thisrow{1}/\thisrow{2}] {\mytable};
  \end{axis}
\end{tikzpicture}
\caption{Зависимость ускорения расчета тестовой задачи от числа узлов расчетной сетки на одном GPU по сравнению с одним CPU}
\label{cuda_speedup}
\end{center}
\end{figure}

Следует отметить, что~эффективное использование больших вычислительных
мощностей является трудоемкой задачей и~требует глубокого исследования и~понимания
архитектуры вычислительных систем.
